SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0;
SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0;
SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION';

CREATE SCHEMA IF NOT EXISTS `mydb` DEFAULT CHARACTER SET utf8 ;
USE `mydb` ;

CREATE TABLE IF NOT EXISTS `mydb`.`Дисциплина` (
  `idДисциплина` INT NOT NULL auto_increment,
  `Название` VARCHAR(100) NULL,
  `Тип оценки` VARCHAR(45) NULL,
  `Кол_во_часов` INT NULL,
  PRIMARY KEY (`idДисциплина`))
ENGINE = InnoDB;

CREATE TABLE IF NOT EXISTS `mydb`.`Группа` (
  `idГруппа` INT NOT NULL auto_increment,
  `Номер` VARCHAR(45) NULL,
  `Семестр` INT NULL,
  `Курс` INT NULL,
  PRIMARY KEY (`idГруппа`),
  UNIQUE INDEX `idГруппа_UNIQUE` (`idГруппа` ASC) VISIBLE)
ENGINE = InnoDB;

CREATE TABLE IF NOT EXISTS `mydb`.`Студент` (
  `idСтудент` INT NOT NULL auto_increment,
  `Фамилия` VARCHAR(45) NULL,
  `Имя` VARCHAR(50) NULL,
  `Отчество` VARCHAR(50) NULL DEFAULT NULL,
  `Пол` ENUM('male', 'female') NULL,
  `Дата рождения` DATE NULL,
  `Адрес` VARCHAR(255) NULL,
  `Группа_idГруппа1` INT NOT NULL,
  PRIMARY KEY (`idСтудент`),
  UNIQUE INDEX `idСтудент_UNIQUE` (`idСтудент` ASC) VISIBLE,
  INDEX `fk_Студент_Группа1_idx` (`Группа_idГруппа1` ASC) VISIBLE,
  CONSTRAINT `fk_Студент_Группа1`
    FOREIGN KEY (`Группа_idГруппа1`)
    REFERENCES `mydb`.`Группа` (`idГруппа`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB;

CREATE TABLE IF NOT EXISTS `mydb`.`Успеваемость` (
  `idУспеваемость` INT auto_increment,
  `Оценка` INT NULL,
  `Дисциплина_idДисциплина` INT NOT NULL,
  `Студент_idСтудент` INT NOT NULL,
  PRIMARY KEY (`idУспеваемость`),
  UNIQUE INDEX `idУспеваемость_UNIQUE` (`idУспеваемость` ASC),
  INDEX `fk_Успеваемость_Дисциплина1_idx` (`Дисциплина_idДисциплина` ASC) VISIBLE,
  INDEX `fk_Успеваемость_Студент1_idx` (`Студент_idСтудент` ASC) VISIBLE,
  CONSTRAINT `fk_Успеваемость_Дисциплина1`
    FOREIGN KEY (`Дисциплина_idДисциплина`)
    REFERENCES `mydb`.`Дисциплина` (`idДисциплина`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION,
  CONSTRAINT `fk_Успеваемость_Студент1`
    FOREIGN KEY (`Студент_idСтудент`)
    REFERENCES `mydb`.`Студент` (`idСтудент`)
    ON DELETE NO ACTION
    ON UPDATE NO ACTION)
ENGINE = InnoDB;


SET SQL_MODE=@OLD_SQL_MODE;
SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS;
SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS;

-- ЗАДАНИЕ 2 --

INSERT INTO `Группа` (`idГруппа`, `Номер`, `Семестр`, `Курс`)
VALUES
(1, 'ИВТ-101', 1, 1),
(2, 'ИВТ-102', 2, 1),
(3, 'ИВТ-201', 3, 2),
(4, 'ИВТ-202', 4, 2),
(5, 'ИВТ-301', 5, 3),
(6, 'ИВТ-302', 6, 3),
(7, 'ИВТ-401', 7, 4),
(8, 'ИВТ-402', 8, 4),
(9, 'ФИИТ-101', 1, 1),
(10, 'ФИИТ-201', 3, 2);

INSERT INTO `Дисциплина` (`idДисциплина`, `Название`, `Тип оценки`, `Кол_во_часов`)
VALUES
(1, 'Математика', 'экзамен', 72),
(2, 'Физика', 'экзамен', 64),
(3, 'Программирование', 'экзамен', 90),
(4, 'Базы данных', 'зачет', 60),
(5, 'Алгоритмы', 'экзамен', 80),
(6, 'Операционные системы', 'экзамен', 70),
(7, 'Информатика', 'зачет', 50),
(8, 'Английский язык', 'зачет', 40),
(9, 'Экономика', 'экзамен', 60),
(10, 'Компьютерные сети', 'экзамен', 75);

INSERT INTO `Студент`
(`idСтудент`, `Фамилия`, `Имя`, `Отчество`, `Пол`, `Дата рождения`, `Адрес`, `Группа_idГруппа1`)
VALUES
(1, 'Иванов', 'Петр', 'Александрович', 'male', '2004-03-15', 'ул. Ленина, 5', 1),
(2, 'Сидорова', 'Анна', 'Викторовна', 'female', '2005-07-02', 'ул. Пушкина, 10', 1),
(3, 'Кузнецов', 'Илья', 'Сергеевич', 'male', '2003-11-20', 'ул. Гагарина, 12', 2),
(4, 'Петрова', 'Екатерина', 'Олеговна', 'female', '2004-06-10', 'ул. Советская, 3', 3),
(5, 'Смирнов', 'Дмитрий', 'Павлович', 'male', '2002-09-09', 'ул. Кирова, 7', 3),
(6, 'Орлова', 'Мария', 'Ивановна', 'female', '2003-01-22', 'ул. Чехова, 18', 4),
(7, 'Федоров', 'Максим', 'Николаевич', 'male', '2004-08-10', 'ул. Победы, 2', 4),
(8, 'Беляева', 'Ольга', 'Романовна', 'female', '2005-03-05', 'ул. Калинина, 11', 5),
(9, 'Киселев', 'Артем', 'Дмитриевич', 'male', '2003-10-28', 'ул. Молодежная, 14', 6),
(10, 'Новикова', 'Алина', 'Петровна', 'female', '2002-12-13', 'ул. Центральная, 8', 7);

INSERT INTO `Успеваемость` (`Оценка`, `Дисциплина_idДисциплина`, `Студент_idСтудент`)
VALUES
(5, 1, 1),
(4, 3, 1),
(5, 2, 2),
(5, 4, 2),
(3, 5, 3),
(4, 6, 4),
(5, 1, 5),
(5, 3, 6),
(4, 4, 7),
(5, 2, 8),
(4, 7, 9),
(5, 8, 10),
(5, 9, 3),
(3, 10, 5),
(4, 5, 6);


-- ЗАДАНИЕ 3 --
-- 1. успеваемость студента по дисциплинам

SELECT 
    s.Фамилия,
    s.Имя,
    d.Название AS Дисциплина,
    u.Оценка,
    d.`Кол_во_часов` AS Часы,
    d.`Тип оценки` AS Вид_контроля
FROM Успеваемость u
JOIN Студент s ON u.Студент_idСтудент = s.idСтудент
JOIN Дисциплина d ON u.Дисциплина_idДисциплина = d.idДисциплина
WHERE s.idСтудент = 1;

-- 2. успеваемость студентов по группам и дисциплинам

SELECT 
    g.Номер AS Группа,
    d.Название AS Дисциплина,
    s.Фамилия,
    s.Имя,
    u.Оценка
FROM Успеваемость u
JOIN Студент s ON u.Студент_idСтудент = s.idСтудент
JOIN Группа g ON s.Группа_idГруппа1 = g.idГруппа
JOIN Дисциплина d ON u.Дисциплина_idДисциплина = d.idДисциплина
ORDER BY g.Номер, d.Название, s.Фамилия;

-- 3. группы с наибольшей средней успеваемостью
SELECT 
    g.Номер AS Группа,
    ROUND(AVG(u.Оценка), 2) AS Средняя_оценка
FROM Успеваемость u
JOIN Студент s ON u.Студент_idСтудент = s.idСтудент
JOIN Группа g ON s.Группа_idГруппа1 = g.idГруппа
GROUP BY g.idГруппа
ORDER BY Средняя_оценка DESC
LIMIT 1;

-- 4. дисциплины с наибольшей средней успеваемостью
SELECT 
    d.Название AS Дисциплина,
    ROUND(AVG(u.Оценка), 2) AS Средняя_оценка
FROM Успеваемость u
JOIN Дисциплина d ON u.Дисциплина_idДисциплина = d.idДисциплина
GROUP BY d.idДисциплина
ORDER BY Средняя_оценка DESC
LIMIT 1;

-- 5. возраст студентов с наибольшей успеваемостью
SELECT 
    s.Фамилия,
    s.Имя,
    TIMESTAMPDIFF(YEAR, s.`Дата рождения`, CURDATE()) AS Возраст,
    ROUND(AVG(u.Оценка), 2) AS Средняя_оценка
FROM Успеваемость u
JOIN Студент s ON u.Студент_idСтудент = s.idСтудент
GROUP BY s.idСтудент
ORDER BY Средняя_оценка DESC
LIMIT 1;

-- 6. дисциплины изучаемые группой студентов на определенном курсе или семестре
SELECT DISTINCT
    g.Номер AS Группа,
    g.Курс,
    g.Семестр,
    d.Название AS Дисциплина
FROM Успеваемость u
JOIN Студент s ON u.Студент_idСтудент = s.idСтудент
JOIN Группа g ON s.Группа_idГруппа1 = g.idГруппа
JOIN Дисциплина d ON u.Дисциплина_idДисциплина = d.idДисциплина
WHERE g.Курс = 2   -- или g.Семестр = 3
ORDER BY g.Номер, d.Название;

-- 7. дисциплины которые не изучаются студентами на данный момент
SELECT 
    d.Название AS Дисциплина
FROM Дисциплина d
LEFT JOIN Успеваемость u ON d.idДисциплина = u.Дисциплина_idДисциплина
WHERE u.Дисциплина_idДисциплина IS NULL;

-- ЗАДАНИЕ 4 --
-- 1. Запрос на выборку избранных полей таблицы, 
--    с использованием синонима (алиаса) и сортировкой записей (ORDER BY)
SELECT 
    s.Фамилия AS Фамилия,
    s.Имя AS Имя,
    g.Номер AS Группа,
    s.`Дата рождения` AS Дата_рождения
FROM Студент s
JOIN Группа g ON s.Группа_idГруппа1 = g.idГруппа
ORDER BY s.Фамилия ASC, s.Имя ASC;

-- 2. Запрос с использованием сортировки (ORDER BY) и группировки (GROUP BY)

SELECT 
    g.Номер AS Группа,
    ROUND(AVG(u.Оценка), 2) AS Средняя_оценка
FROM Успеваемость u
JOIN Студент s ON u.Студент_idСтудент = s.idСтудент
JOIN Группа g ON s.Группа_idГруппа1 = g.idГруппа
GROUP BY g.Номер
ORDER BY Средняя_оценка DESC;

-- 3. Запрос с использованием предложения DISTINCT
SELECT DISTINCT g.Курс
FROM Группа g;

-- 4. Запрос с использованием операций сравнения
SELECT 
    s.Фамилия,
    s.Имя,
    u.Оценка
FROM Успеваемость u
JOIN Студент s ON u.Студент_idСтудент = s.idСтудент
WHERE u.Оценка >= 4;

-- 5. Запросы для предикатов: IN, BETWEEN, LIKE, IS NULL
-- 5.1. IN — студенты из выбранных групп
SELECT Фамилия, Имя
FROM Студент
WHERE Группа_idГруппа1 IN (1, 2, 3);

-- 5.2. BETWEEN — студенты, родившиеся между 2003 и 2005 годом
SELECT Фамилия, Имя, `Дата рождения`
FROM Студент
WHERE `Дата рождения` BETWEEN '2003-01-01' AND '2005-12-31';

-- 5.3. LIKE — фамилии, начинающиеся на "К"
SELECT Фамилия, Имя
FROM Студент
WHERE Фамилия LIKE 'К%';

-- 5.4. IS NULL — дисциплины без оценок
SELECT d.Название
FROM Дисциплина d
LEFT JOIN Успеваемость u ON d.idДисциплина = u.Дисциплина_idДисциплина
WHERE u.Оценка IS NULL;

-- 6. Агрегатные функции (COUNT, SUM, AVG, MAX, MIN) + GROUP BY и HAVING
SELECT 
    g.Номер AS Группа,
    COUNT(u.Оценка) AS Количество_оценок,
    ROUND(AVG(u.Оценка), 2) AS Средняя_оценка,
    MAX(u.Оценка) AS Лучшая_оценка,
    MIN(u.Оценка) AS Худшая_оценка
FROM Успеваемость u
JOIN Студент s ON u.Студент_idСтудент = s.idСтудент
JOIN Группа g ON s.Группа_idГруппа1 = g.idГруппа
GROUP BY g.Номер
HAVING Средняя_оценка > 4.0;

-- 7. Запрос на выборку данных из двух связанных таблиц 
--    с сортировкой по нескольким полям
SELECT 
    s.Фамилия,
    s.Имя,
    g.Номер AS Группа,
    g.Курс
FROM Студент s
JOIN Группа g ON s.Группа_idГруппа1 = g.idГруппа
ORDER BY g.Курс DESC, s.Фамилия ASC;

-- 8. Многотабличный запрос с использованием 
--    внутреннего (INNER) и внешнего (LEFT) соединения
SELECT 
    s.Фамилия,
    d.Название AS Дисциплина,
    u.Оценка,
    g.Номер AS Группа
FROM Успеваемость u
INNER JOIN Студент s ON u.Студент_idСтудент = s.idСтудент
INNER JOIN Группа g ON s.Группа_idГруппа1 = g.idГруппа
LEFT JOIN Дисциплина d ON u.Дисциплина_idДисциплина = d.idДисциплина
ORDER BY s.Фамилия;

-- 9. Многотабличный запрос с использованием оператора UNION
SELECT 
    s.Фамилия AS Имя_участника, 
    'Студент' AS Роль
FROM Студент s

UNION

SELECT 
    g.Номер AS Имя_участника, 
    'Группа' AS Роль
FROM Группа g;

-- 10. Подзапрос в части WHERE и HAVING
-- 10.1. Подзапрос в WHERE — студенты, у которых оценка выше средней по всем
SELECT 
    s.Фамилия,
    s.Имя,
    u.Оценка
FROM Успеваемость u
JOIN Студент s ON u.Студент_idСтудент = s.idСтудент
WHERE u.Оценка > (SELECT AVG(Оценка) FROM Успеваемость);

-- 10.2. Подзапрос в HAVING — группы с средней оценкой выше общей средней
SELECT 
    g.Номер,
    AVG(u.Оценка) AS Средняя_оценка
FROM Успеваемость u
JOIN Студент s ON u.Студент_idСтудент = s.idСтудент
JOIN Группа g ON s.Группа_idГруппа1 = g.idГруппа
GROUP BY g.Номер
HAVING AVG(u.Оценка) > (SELECT AVG(Оценка) FROM Успеваемость);

-- 11. Подзапросы с операторами ALL, EXISTS, ANY
-- 11.1. EXISTS — студенты, у которых есть хотя бы одна оценка "5"
SELECT 
    s.Фамилия,
    s.Имя
FROM Студент s
WHERE EXISTS (
    SELECT 1 FROM Успеваемость u
    WHERE u.Студент_idСтудент = s.idСтудент AND u.Оценка = 5
);

-- 11.2. ANY — студенты, чья оценка выше хотя бы одной оценки по математике
SELECT 
    s.Фамилия,
    s.Имя
FROM Студент s
JOIN Успеваемость u ON s.idСтудент = u.Студент_idСтудент
WHERE u.Оценка > ANY (
    SELECT Оценка FROM Успеваемость
    WHERE Дисциплина_idДисциплина = 1
);

-- 11.3. ALL — студенты, у которых все оценки выше, чем у любого по физике
SELECT 
    s.Фамилия,
    s.Имя
FROM Студент s
WHERE 5 > ALL (
    SELECT Оценка FROM Успеваемость
    WHERE Дисциплина_idДисциплина = 2
);
